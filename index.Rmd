---
title: "COVID-19 01 de octubre de 2020"
author: "Por Jorge Cuamatzi"
date: '`r format(Sys.Date())`'
output: html_document
---

```{r setup, include=FALSE, fig.align="center"}
knitr::opts_chunk$set(echo = TRUE)
```

``` {css, include=FALSE, fig.align="center"}
.columns {display: flex;}
h1 {color: red;}
h2 {color: green;}
```

# 01 de octubre de 2020

```{r, include=FALSE, warning=FALSE, fig.align="center"}
library(tidyr)
library(janitor)
library(mxmaps)
library(ggplot2)
library(plotly)
library(plyr);library(dplyr)
library(viridis)
library(knitr)
library(kableExtra)
library(leaflet)
library(grid)
```

## Obteniendo datos diarios de COVID-19 en México desde el portal habilitado por el [Gobierno Federal](http://datosabiertos.salud.gob.mx/gobmx/salud/datos_abiertos/datos_abiertos_covid19.zip)


```{r Database, include=FALSE, warning=FALSE, fig.align="center"}
temp <- tempfile()
download.file("http://datosabiertos.salud.gob.mx/gobmx/salud/datos_abiertos/datos_abiertos_covid19.zip",temp)
Mex_Data_COVID <- read.csv(unz(temp, "201001COVID19MEXICO.csv"))
unlink(temp); rm(temp)
```

``` {r include=FALSE, warning=FALSE, fig.align="center"}
# Empezar a manipular los datos
# Información imporante:
# En resultados, 1 = Positivo, 2 = Negativo, 3 = Pendiente de resultado
# En sexo, 1 = Hombre, 2 = Mujer
# Vamos a emplear la librería mxmaps

Mex_Data_COVID$ENTIDAD_RES <- sprintf("%02d", as.numeric(Mex_Data_COVID$ENTIDAD_RES))
Mex_Data_COVID$MUNICIPIO_RES <- sprintf("%03d", as.numeric(Mex_Data_COVID$MUNICIPIO_RES))

## A partir de la información de mxmaps, agregamos las columnas de region y nombre del estado
Mex_Data_COVID <- Mex_Data_COVID %>%
  janitor::clean_names() %>%
  left_join(select(df_mxstate, region, state_name),
            by = c("entidad_res" = "region"))

Mex_Data_COVID$resultado[Mex_Data_COVID$resultado == "1"] <- "Positivo"
Mex_Data_COVID$resultado[Mex_Data_COVID$resultado == "2"] <- "Negativo"
Mex_Data_COVID$resultado[Mex_Data_COVID$resultado == "3"] <- "Pendiente"

Mex_Data_COVID$tipo_paciente[Mex_Data_COVID$tipo_paciente == "1"] <- "Ambulatorio"
Mex_Data_COVID$tipo_paciente[Mex_Data_COVID$tipo_paciente == "2"] <- "Hospitalizado"

Mex_Data_COVID$sexo[Mex_Data_COVID$sexo == "1"] <- "Hombre"
Mex_Data_COVID$sexo[Mex_Data_COVID$sexo == "2"] <- "Mujer"
Mex_Data_COVID$value <- Mex_Data_COVID$resultado


```


```{r, echo=FALSE, fig.align="center"}
NumPosMex <- Mex_Data_COVID %>% 
  dplyr::filter(resultado == "Positivo") %>% 
  dplyr::summarise("Pacientes positivos en México" = dplyr::n())

kbl(NumPosMex) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")


```

```{r, echo = FALSE, fig.align="center"}
NumNegMex <- Mex_Data_COVID %>% 
  dplyr::filter(resultado == "Negativo") %>% 
  dplyr::summarise("Pacientes negativos en México" = dplyr::n())

kbl(NumNegMex) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

```

```{r, echo=FALSE, fig.align="center"}
NumPenMex <- Mex_Data_COVID %>% 
  dplyr::filter(resultado == "Pendiente") %>% 
  dplyr::summarise("Pacientes pendientes en México" = dplyr::n())

kbl(NumPenMex) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

```

## Distribución de casos positivos en México

```{r, echo = FALSE, fig.align="center"}
Pos_Mx <- Mex_Data_COVID[grep("Positivo", Mex_Data_COVID$resultado),]

mn_Mx <- ddply(Pos_Mx, c("state_name"), summarise,
               value = length(value)) %>% 
  left_join(select(df_mxstate, region, state_name),
            by = c("state_name" = "state_name"))

#mxstate_choropleth(mn_Mx, num_colors = 9,title = "Número de casos en México",legend = "Casos")

pal <- colorNumeric("Reds", domain = mn_Mx$value)
mxstate_leaflet(mn_Mx,
                pal,
                ~ pal(value),
                ~sprintf("Estado: %s<br/>Casos: %s",
                         state_name, value)) %>% 
  addLegend(position = "bottomleft", pal = pal, values = mn_Mx$value) %>%
  addProviderTiles("CartoDB.Positron")

```

```{r, echo = FALSE, fig.align="center"}

plot_Mx <- ggplot(Pos_Mx, aes(x = state_name, fill = resultado))+
  geom_bar()+
  theme_classic()+
  labs(y = "Número de casos", x = "Estado") + 
  ggtitle("Casos por estado")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 10, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12),
        plot.title = element_text(face = "bold", color = "red", size = 14, hjust = 0.5)); ggplotly(plot_Mx)

mn_Mx_2 <- ddply(Pos_Mx, c("fecha_sintomas", "tipo_paciente"), summarise,
                           casos = length(value))

plot_casos <- ggplot(mn_Mx_2, aes(x = as.Date(fecha_sintomas), y = casos, fill = tipo_paciente))+
  geom_bar(stat = "identity") +
  theme_classic()+
  scale_fill_manual("Tipo de paciente", values = c("Hospitalizado" = "green", "Ambulatorio" = "gray")) + 
  labs(y = "Número de casos", x = "Fecha de síntomas") + 
  ggtitle("Situación de pacientes")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12),
        plot.title = element_text(face = "bold", color = "red", size = 14, hjust = 0.5))+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_casos)

NumAmbMex <- Mex_Data_COVID %>%
  dplyr::filter(tipo_paciente == "Ambulatorio", resultado == "Positivo") %>% 
  dplyr::summarise("Ambulatorios en México" = dplyr::n())

kbl(NumAmbMex) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

NumHospMex <- Mex_Data_COVID %>% 
  dplyr::filter(tipo_paciente == "Hospitalizado", resultado == "Positivo") %>% 
  dplyr::summarise("Hospitalizados en México" = dplyr::n())

kbl(NumHospMex) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

## Distribución de defunciones en México
```{r, echo = FALSE, fig.align="center"}

Decesos_Mx <- Pos_Mx[-grep("9999-99-99",Pos_Mx$fecha_def),]

NumFallMex <- Decesos_Mx %>% 
  dplyr::filter(resultado == "Positivo") %>% 
  dplyr::summarise("Decesos acumulados en México" = dplyr::n())

kbl(NumFallMex) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

Decesos_Mx_St <- ddply(Decesos_Mx, c("state_name"), summarise,
               value = length(value)) %>% 
  left_join(select(df_mxstate, region, state_name),
            by = c("state_name" = "state_name"))

pal_1 <- colorNumeric("Reds", domain = Decesos_Mx_St$value)

mxstate_leaflet(Decesos_Mx_St,
                pal_1,
                ~ pal_1(value),
                ~sprintf("Estado: %s<br/>Defunciones: %s",
                         state_name, value)) %>% 
  addLegend(position = "bottomleft", pal = pal_1, values = Decesos_Mx_St$value) %>%
  addProviderTiles("CartoDB.Positron")

# Decesos acumulados
plot_Decesos_Mx <- ggplot(Decesos_Mx, aes(x = state_name, fill = resultado))+
  geom_bar()+
  theme_classic()+
  labs(y = "Número de decesos", x = "Estado")+
  ggtitle("Decesos por estado")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 10, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12),
        plot.title = element_text(face = "bold", color = "red", size = 14, hjust = 0.5)); ggplotly(plot_Decesos_Mx)

# Defunciones por día en todo el país
Decesos_Mx_2 <- ddply(Decesos_Mx, c("fecha_def", "tipo_paciente"), summarise,
                 casos = length(value))

plot_decesos <- ggplot(Decesos_Mx_2, aes(x = as.Date(fecha_def), y = casos, fill = tipo_paciente))+
  geom_bar(stat = "identity") +
  theme_classic()+
  scale_fill_manual("Tipo de paciente", values = c("Hospitalizado" = "green", "Ambulatorio" = "gray")) + 
  labs(y = "Número de defunciones", x = "Fecha de defunción")+
  ggtitle("Fallecimientos en México") + 
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12),
        plot.title = element_text(face = "bold", color = "red", size = 14, hjust = 0.5))+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_decesos)


```


## Obteniendo datos para Tlaxcala
```{r, include=FALSE, fig.align="center"}
Tlx_COVID <- Mex_Data_COVID[Mex_Data_COVID$entidad_res == 29,]

# A partir de la librería mxmaps, obtener datos de municipios de Tlaxcala
data("df_mxmunicipio") # adjuntar información por municipio

Tlx_municipio <- df_mxmunicipio[df_mxmunicipio$state_code == 29,] # recordar que el código de Tlax es 29


# Ahora vamos a emparejar columnas del data frame descargado con información del data frame de mxmaps
Tlx_COVID <- Tlx_COVID %>%
  left_join(select(Tlx_municipio, region, municipio_code, municipio_name),
            by = c("municipio_res" = "municipio_code"))

```

```{r, include=FALSE, fig.align="center"}
Pos_Tlax <- Tlx_COVID[grep("Positivo", Tlx_COVID$resultado),]

mn_Tlx <- ddply(Pos_Tlax, c("municipio_name"), summarise,
                value = length(value)) %>%
  left_join(select(Tlx_municipio, region, municipio_code, municipio_name),
            by = c("municipio_name"="municipio_name"))
```

```{r, warning=FALSE, echo=FALSE, fig.align="center"}
NumPosTlx <- Mex_Data_COVID %>% 
  dplyr::filter(resultado == "Positivo",
                state_name == "Tlaxcala") %>% 
  dplyr::summarise("Pacientes positivos en Tlaxcala" = dplyr::n())

kbl(NumPosTlx) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

NumMujTlx <- Mex_Data_COVID %>% 
  dplyr::filter(state_name == "Tlaxcala",
                sexo == "Mujer", 
                resultado == "Positivo") %>% 
  dplyr::summarise("Mujeres contagiadas en Tlaxcala" = dplyr::n())

kbl(NumMujTlx) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

NumHomTlx <- Mex_Data_COVID %>% 
  dplyr::filter(state_name == "Tlaxcala",
                sexo == "Hombre", 
                resultado == "Positivo") %>% 
  dplyr::summarise("Hombres contagiados en Tlaxcala" = dplyr::n())

kbl(NumHomTlx) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

NumNegTlax <- Mex_Data_COVID %>% 
  dplyr::filter(resultado == "Negativo",
                state_name == "Tlaxcala") %>% 
  dplyr::summarise("Pacientes negativos en Tlaxcala" = dplyr::n())

kbl(NumNegTlax) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

NumPenTlx <- Mex_Data_COVID %>% 
  dplyr::filter(resultado == "Pendiente",
                state_name == "Tlaxcala") %>% 
  dplyr::summarise("Pacientes pendientes en Tlaxcala" = dplyr::n())

kbl(NumPenTlx) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

#mxmunicipio_choropleth(mn_Tlx, num_colors = 9,zoom = subset(df_mxmunicipio, state_name %in% c("Tlaxcala"))$region,title = "Número de casos en Tlaxcala",show_states = T,legend = "Casos")

```

## Distribución de casos por municipio en Tlaxcala
```{r, warning=FALSE, echo=FALSE, fig.align="center"}
mn_Tlx$state_name <- rep("Tlaxcala",length(mn_Tlx))
pal <- colorNumeric("Reds", domain = mn_Tlx$value)

mxmunicipio_leaflet(mn_Tlx,
                    pal,
                    ~ pal(value),
                    ~ sprintf("State: %s<br/>Municipio : %s<br/>Value: %s",
                              state_name, municipio_name, value),
                    lng = -98.16957,
                    lat = 19.35029, mapzoom = 9)%>%
  addLegend(position = "bottomright", pal = pal,
            values = mn_Tlx$value) %>%
  addProviderTiles("CartoDB.Positron")


NumPosCtl <- Tlx_COVID %>% 
  dplyr::filter(municipio_name == "Contla de Juan Cuamatzi",
                resultado == "Positivo") %>% 
  dplyr::summarise("Pacientes positivos en Contla" = dplyr::n())

kbl(NumPosCtl) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

NumPosApt <- Tlx_COVID %>% 
  dplyr::filter(municipio_name == "Apetatitlán de Antonio Carvajal",
                resultado == "Positivo") %>% 
  dplyr::summarise("Pacientes positivos en Apetatitlán" = dplyr::n())

kbl(NumPosApt) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

NumPosCht <- Tlx_COVID %>% 
  dplyr::filter(municipio_name == "Chiautempan",
                resultado == "Positivo") %>% 
  dplyr::summarise("Pacientes positivos en Chiautempan" = dplyr::n())

kbl(NumPosCht) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

Defunciones_Tlx <- Tlx_COVID[-grep("9999-99-99",Tlx_COVID$fecha_def),]

NumDefTlx <- Defunciones_Tlx %>% 
  dplyr::filter(resultado == "Positivo") %>% 
  dplyr::summarise("Defunciones por COVID-19 en el estado de Tlaxcala" = dplyr::n())

kbl(NumDefTlx) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

NumDefCtl <- Defunciones_Tlx %>% 
  dplyr::filter(resultado == "Positivo", municipio_name == "Contla de Juan Cuamatzi") %>% 
  dplyr::summarise("Defunciones por COVID-19 en Contla" = dplyr::n())

kbl(NumDefCtl) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

Defunciones_Contla <- Defunciones_Tlx[grep("Contla de Juan Cuamatzi", Defunciones_Tlx$municipio_name),-c(1,2,3,4,5,7,8,9,15,17,18,19,20,21,22,23,24,25,26,27,28,29,30,32,33,34,35,36,37,38,39)]

Defunciones_Contla_COVID <- Defunciones_Contla[grep("Positivo",Defunciones_Contla$resultado),]
Defunciones_Contla_COVID <- Defunciones_Contla[,-8]
#kable_styling(Defunciones_Contla_COVID[order(as.Date(Defunciones_Contla_COVID$fecha_def, descending=TRUE)),],  position = "center")

NumDefCht <- Defunciones_Tlx %>% 
  dplyr::filter(resultado == "Positivo", municipio_name == "Chiautempan") %>% 
  dplyr::summarise("Defunciones por COVID-19 en Chiautempan" = dplyr::n())

kbl(NumDefCht) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

Defunciones_Chiautempan <- Defunciones_Tlx[grep("Chiautempan", Defunciones_Tlx$municipio_name),-c(1,2,3,4,5,7,8,9,15,17,18,19,20,21,22,23,24,25,26,27,28,29,30,32,33,34,35,36,37,38,39)]

Defunciones_Chiautempan_COVID <- Defunciones_Chiautempan[grep("Positivo",Defunciones_Chiautempan$resultado),]
Defunciones_Chiautempan_COVID <- Defunciones_Chiautempan[,-8]
#kable(Defunciones_Chiautempan_COVID[order(as.Date(Defunciones_Chiautempan_COVID$fecha_def, descending=TRUE)),], row.names = F)

```

```{r, warning=FALSE, echo=FALSE, fig.align="center"}
plot_Tlx_2 <- ggplot(Pos_Tlax, aes(x = municipio_name, fill = resultado))+
  geom_bar()+
  theme_classic()+
  labs(y = "Número de casos", x = "Municipio")+
  ggtitle("Casos por municipio en Tlaxcala") + 
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 10, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 11),
        axis.title.y = element_text(face = "bold", color = "black", size = 11),
        plot.title = element_text(face = "bold", color = "red", size = 14, hjust = 0.5)); ggplotly(plot_Tlx_2)

mn_Tlx_2 <- ddply(Pos_Tlax, c("fecha_sintomas", "tipo_paciente"), summarise,
                  casos = length(resultado))

n_Tlx <- sum(mn_Tlx_2$casos)

plot_casos_Tlx <- ggplot(mn_Tlx_2, aes(x = as.Date(fecha_sintomas), y = casos, fill = tipo_paciente))+
  geom_bar(stat = "identity") + 
  theme_classic()+
  scale_fill_manual("Tipo de paciente", values = c("Hospitalizado" = "green", "Ambulatorio" = "gray"))+
  labs(y = "Número de casos", x = "Fecha de síntomas")+
  ggtitle("Situación de pacientes en Tlaxcala") + 
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12),
        plot.title = element_text(face = "bold", color = "red", size = 14, hjust = 0.5)) +
  scale_x_date(date_breaks = "months" , date_labels = "%b") +
  annotate(geom="text", x=as.Date("2020-04-10"), y=80, label= c("n=            ",n_Tlx), color="red"); ggplotly(plot_casos_Tlx)

mn_Tlx_3 <- ddply(Tlx_COVID, c("fecha_ingreso", "resultado"), summarise,
                  casos = length(resultado))

plot_ingreso <- ggplot(mn_Tlx_3) +
  geom_bar(stat = "identity",  aes(x=as.Date(fecha_ingreso), y=casos, fill=resultado)) + 
  theme(legend.position = "none") + 
  theme_classic() +
  labs(y = "Número de sospechosos", x = "Fecha de ingreso") +
  ggtitle("Incidencia de resultados") + 
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12),
        plot.title = element_text(face = "bold", color = "red", size = 14, hjust=0.5))+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_ingreso)


NumAmbTlx <- Tlx_COVID %>% 
  dplyr::filter(tipo_paciente == "Ambulatorio", resultado == "Positivo") %>% 
  dplyr::summarise("Pacientes ambulatorios en Tlaxcala" = dplyr::n())

kbl(NumAmbTlx) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

NumHospTlx <- Tlx_COVID %>% 
  dplyr::filter(tipo_paciente == "Hospitalizado", resultado == "Positivo") %>% 
  dplyr::summarise("Pacientes hospitalizados en Tlaxcala" = dplyr::n())

kbl(NumHospTlx) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

## Defunciones por municipio en Tlaxcala

```{r warning=FALSE, echo=FALSE, fig.align="center"}
Defunciones_Tlax <- Pos_Tlax[-grep("9999-99-99", Pos_Tlax$fecha_def),]

Defunciones_Tlx_2 <- ddply(Defunciones_Tlax, c("municipio_name"), summarise,
                value = length(value)) %>%
  left_join(select(Tlx_municipio, region, municipio_code, municipio_name),
            by = c("municipio_name"="municipio_name"))

Defunciones_Tlx_2$state_name <- rep("Tlaxcala",length(Defunciones_Tlx_2$value))


pal_df_Tlax <- colorNumeric("Reds", domain = Defunciones_Tlx_2$value)

mxmunicipio_leaflet(Defunciones_Tlx_2,
                    pal_df_Tlax,
                    ~ pal_df_Tlax(value),
                    ~ sprintf("Estado: %s<br/>Municipio : %s<br/>Defunciones: %s",
                              state_name, municipio_name, value),
                    lng = -98.16957,
                    lat = 19.35029, mapzoom = 9)%>%
  addLegend(position = "bottomright", pal = pal_df_Tlax,
            values = Defunciones_Tlx_2$value) %>%
  addProviderTiles("CartoDB.Positron")


Defunciones_Tlx_2 <- ddply(Defunciones_Tlax, c("fecha_def", "tipo_paciente"), summarise,
                  casos = length(resultado))

n_def_Tlx <- sum(Defunciones_Tlx_2$casos)

plot_Defunciones_Tlx <- ggplot(Defunciones_Tlx_2, aes(x = as.Date(fecha_def), y = casos, fill = tipo_paciente))+
  geom_bar(stat = "identity") + 
  theme_classic()+
  scale_fill_manual("Tipo de paciente", values = c("Hospitalizado" = "green", "Ambulatorio" = "gray"))+
  labs(y = "Número de defunciones", x = "Fecha de defunción") + 
  ggtitle("Defunciones en Tlaxcala") +
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12),
        plot.title = element_text(face = "bold", color = "red", size = 14, hjust = 0.5)) +
  scale_x_date(date_breaks = "months" , date_labels = "%b") +
  annotate(geom="text", x=as.Date("2020-05-01"), y=25, label= c("n=            ",n_def_Tlx), color="red"); ggplotly(plot_Defunciones_Tlx)



```

```{r, warning=FALSE, echo=FALSE, fig.align="center"}
marzo_tlax <- Mex_Data_COVID[grep("-03-", Mex_Data_COVID$fecha_def),]
marzo_tlax <- marzo_tlax[grep("29",marzo_tlax$entidad_res),]
marzo_tlax <- marzo_tlax[grep("Positivo", marzo_tlax$resultado),]
marzo_tlax$mes <- rep("Marzo", length(marzo_tlax$fecha_actualizacion))

abril_tlax <- Mex_Data_COVID[grep("-04-", Mex_Data_COVID$fecha_def),]
abril_tlax <- abril_tlax[grep("29",abril_tlax$entidad_res),]
abril_tlax <- abril_tlax[grep("Positivo", abril_tlax$resultado),]
abril_tlax$mes <- rep("Abril", length(abril_tlax$fecha_actualizacion))

mayo_tlax <- Mex_Data_COVID[grep("-05-", Mex_Data_COVID$fecha_def),]
mayo_tlax <- mayo_tlax[grep("29",mayo_tlax$entidad_res),]
mayo_tlax <- mayo_tlax[grep("Positivo", mayo_tlax$resultado),]
mayo_tlax$mes <- rep("Mayo", length(mayo_tlax$fecha_actualizacion))

jun_tlax <- Mex_Data_COVID[grep("-06-", Mex_Data_COVID$fecha_def),]
jun_tlax <- jun_tlax[grep("29",jun_tlax$entidad_res),]
jun_tlax <- jun_tlax[grep("Positivo", jun_tlax$resultado),]
jun_tlax$mes <- rep("Junio", length(jun_tlax$fecha_actualizacion))

jul_tlax <- Mex_Data_COVID[grep("-07-", Mex_Data_COVID$fecha_def),]
jul_tlax <- jul_tlax[grep("29",jul_tlax$entidad_res),]
jul_tlax <- jul_tlax[grep("Positivo", jul_tlax$resultado),]
jul_tlax$mes <- rep("Julio", length(jul_tlax$fecha_actualizacion))

agos_tlax <- Mex_Data_COVID[grep("-08-", Mex_Data_COVID$fecha_def),]
agos_tlax <- agos_tlax[grep("29",agos_tlax$entidad_res),]
agos_tlax <- agos_tlax[grep("Positivo", agos_tlax$resultado),]
agos_tlax$mes <- rep("Agosto", length(agos_tlax$fecha_actualizacion))

sept_tlax <- Mex_Data_COVID[grep("-09-", Mex_Data_COVID$fecha_def),]
sept_tlax <- sept_tlax[grep("29",sept_tlax$entidad_res),]
sept_tlax <- sept_tlax[grep("Positivo", sept_tlax$resultado),]
sept_tlax$mes <- rep("Septiembre", length(sept_tlax$fecha_actualizacion))

oct_tlax <- Mex_Data_COVID[grep("-10-", Mex_Data_COVID$fecha_def),]
oct_tlax <- oct_tlax[grep("29",oct_tlax$entidad_res),]
oct_tlax <- oct_tlax[grep("Positivo", oct_tlax$resultado),]
oct_tlax$mes <- rep("Octubre", length(oct_tlax$fecha_actualizacion))

def_mes_Tlx <- bind_rows(marzo_tlax, abril_tlax, mayo_tlax, jun_tlax, jul_tlax, agos_tlax, sept_tlax, oct_tlax)
def_mes_Tlx$mes <- factor(def_mes_Tlx$mes,  levels = c("Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre"))

Def_edad_Tlx_meses <- ggplot(def_mes_Tlx, aes(x= sexo, y = edad))+
  facet_wrap(~ mes)+
  geom_boxplot(notch = T, outlier.colour="red", outlier.shape=8,outlier.size=4) +
  ggtitle("Defunciones por sexo y edad en Tlaxcala") +
  theme_classic()+ 
  labs(y = "Edad", x = "Sexo")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 11, angle = 0),
        axis.text.y = element_text(face = "bold", color = "blue", size = 11, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12),
        plot.title = element_text(face = "bold", color = "red", size = 14, hjust = 0.5),
        panel.spacing = unit(2, "lines")); ggplotly(Def_edad_Tlx_meses)


```



# Datos de Puebla
```{r, warning=FALSE, echo=FALSE, fig.align="center"}
Pue_COVID <- Mex_Data_COVID[Mex_Data_COVID$entidad_res == 21,]

# A partir de la librería mxmaps, obtener datos de municipios de Puebla
data("df_mxmunicipio") # adjuntar información por municipio

Pue_municipio <- df_mxmunicipio[df_mxmunicipio$state_code == 21,] # recordar que el código de Pue es 21


# Ahora vamos a emparejar columnas del data frame descargado con información del data frame de mxmaps
Pue_COVID <- Pue_COVID %>%
  left_join(select(Pue_municipio, region, municipio_code, municipio_name),
            by = c("municipio_res" = "municipio_code"))


```

```{r, warning=FALSE, echo=FALSE, fig.align="center"}
NumPosPue <- Mex_Data_COVID %>% 
  dplyr::filter(resultado == "Positivo",
                state_name == "Puebla") %>% 
  dplyr::summarise("Pacientes positivos en Puebla" = dplyr::n())

kbl(NumPosPue) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

Pos_Pue <- Pue_COVID[grep("Positivo", Pue_COVID$resultado),]


mn_Pue_2 <- ddply(Pos_Pue, c("fecha_sintomas", "tipo_paciente"), summarise,
                  casos = length(resultado))

n_Pue <- sum(mn_Pue_2$casos)

plot_casos_Pue <- ggplot(mn_Pue_2, aes(x = as.Date(fecha_sintomas), y = casos, fill = tipo_paciente))+
  geom_bar(stat = "identity") + 
  theme_classic()+
  scale_fill_manual("Tipo de paciente", values = c("Hospitalizado" = "green", "Ambulatorio" = "gray"))+
  labs(y = "Número de casos", x = "Fecha de síntomas")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12)) +
  annotate(geom="text", x=as.Date("2020-04-10"), y=350, label= c("n=              ",n_Pue),
              color="red")+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_casos_Pue)


mn_Pue_3 <- ddply(Pue_COVID, c("fecha_ingreso", "resultado"), summarise,
                  casos = length(resultado))


Mujeres_Puebla_de_Veracruz <- Pue_COVID[grep("Puebla",Pue_COVID$municipio_name),]
Mujeres_Puebla_de_Veracruz <- Mujeres_Puebla_de_Veracruz[grep("30",Mujeres_Puebla_de_Veracruz$entidad_nac),]
Mujeres_Puebla_de_Veracruz <- Mujeres_Puebla_de_Veracruz[grep("Negativo",Mujeres_Puebla_de_Veracruz$value),]
Mujeres_Puebla_de_Veracruz <- Mujeres_Puebla_de_Veracruz[grep("30",Mujeres_Puebla_de_Veracruz$edad),]

plot_ingreso_Pue <- ggplot(mn_Pue_3)+
  geom_bar(stat = "identity",  aes ( x = as.Date(fecha_ingreso), y = casos, fill = resultado)) + 
  theme(legend.position = "none") + 
  theme_classic() +
  labs(y = "Número de sospechosos", x = "Fecha de ingreso")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12))+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_ingreso_Pue)

```

# Datos de Veracruz
```{r, warning=FALSE, echo=FALSE, fig.align="center"}
Ver_COVID <- Mex_Data_COVID[Mex_Data_COVID$entidad_res == 30,]

# A partir de la librería mxmaps, obtener datos de municipios de Puebla
data("df_mxmunicipio") # adjuntar información por municipio

Ver_municipio <- df_mxmunicipio[df_mxmunicipio$state_code == 30,] # recordar que el código de Ver es 30

# Ahora vamos a emparejar columnas del data frame descargado con información del data frame de mxmaps
Ver_COVID <- Ver_COVID %>%
  left_join(select(Ver_municipio, region, municipio_code, municipio_name),
            by = c("municipio_res" = "municipio_code"))
```

```{r, warning=FALSE, echo=FALSE, fig.align="center"}
Pos_Ver <- Ver_COVID[grep("Positivo", Ver_COVID$resultado),]


mn_Ver_2 <- ddply(Pos_Ver, c("fecha_sintomas", "tipo_paciente"), summarise,
                  casos = length(resultado))

n_Ver <- sum(mn_Ver_2$casos)

plot_casos_Ver <- ggplot(mn_Ver_2, aes(x = as.Date(fecha_sintomas), y = casos, fill = tipo_paciente))+
  geom_bar(stat = "identity") + 
  theme_classic()+
  scale_fill_manual("Tipo de paciente", values = c("Hospitalizado" = "green", "Ambulatorio" = "gray"))+
  labs(y = "Número de casos", x = "Fecha de síntomas")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12)) +
  annotate(geom="text", x=as.Date("2020-04-10"), y=350, label= c("n=              ",n_Ver),
              color="red")+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_casos_Ver)

mn_ver_3 <- ddply(Ver_COVID, c("fecha_ingreso", "resultado"), summarise,
                  casos = length(resultado))

plot_ingreso_Ver <- ggplot(mn_ver_3)+
  geom_bar(stat = "identity",  aes ( x = as.Date(fecha_ingreso), y = casos, fill = resultado)) + 
  theme(legend.position = "none") + 
  theme_classic() +
  labs(y = "Número de sospechosos", x = "Fecha de ingreso")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12))+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_ingreso_Ver)

Huatusco <- Ver_COVID[grep("Huatusco",Ver_COVID$municipio_name),-c(1,2,3,4,5,7,8,9,15,17,18,19,20,21,22,23,24,25,26,27,28,29,30,32,33,34,35,36,37,38,39)]

NumHuaPos <- Huatusco %>% 
  dplyr::filter(resultado == "Positivo") %>% 
  dplyr::summarise("Pacientes positivos de COVID-19 en Huatusco, Ver" = dplyr::n())

kbl(NumHuaPos) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

Defunciones_Huatusco <- Huatusco[-grep("9999-99-99",Huatusco$fecha_def),]

Defunciones_Huatusco_COVID <- Defunciones_Huatusco[grep("Positivo", Defunciones_Huatusco$resultado),]
Defunciones_Huatusco_COVID <- Defunciones_Huatusco[,-8]

#kable(Defunciones_Huatusco_COVID[order(as.Date(Defunciones_Huatusco_COVID$fecha_def, descending=TRUE)),], row.names = F)

Orizaba <- Ver_COVID[grep("Orizaba",Ver_COVID$municipio_name),-c(1,2,3,4,5,7,8,9,15,17,18,19,20,21,22,23,24,25,26,27,28,29,30,32,33,34,35,36,37,38,39)]


NumOriPos <- Orizaba %>% 
  dplyr::filter(resultado == "Positivo") %>% 
  dplyr::summarise("Casos de COVID-19 en Orizaba, Ver" = n())

kbl(NumOriPos) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

Orizaba_mujeres <- Orizaba %>% 
  dplyr::filter(sexo == "Mujer") %>% 
  dplyr::filter(resultado == "Positivo") %>% 
  dplyr::filter(edad == 26)


Orizaba_hombres <- Orizaba %>% 
  dplyr::filter(sexo == "Hombre") %>% 
  dplyr::filter(resultado == "Positivo")

Defunciones_Orizaba <- Orizaba[-grep("9999-99-99",Orizaba$fecha_def),]

Defunciones_Orizaba_COVID <- Defunciones_Orizaba[grep("Positivo", Defunciones_Orizaba$resultado),]

NumDefOri <- Defunciones_Orizaba_COVID %>% 
  dplyr::filter(resultado == "Positivo") %>% 
  dplyr::summarise("Defunciones por COVID-19 en Orizaba" = n())

kbl(NumDefOri) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

```
# Datos para Querétaro
```{r, warning=FALSE, echo=FALSE, fig.align="center"}
Qro_COVID <- Mex_Data_COVID[Mex_Data_COVID$entidad_res == 22,]

# A partir de la librería mxmaps, obtener datos de municipios de Qro
data("df_mxmunicipio") # adjuntar información por municipio

Qro_municipio <- df_mxmunicipio[df_mxmunicipio$state_code == 22,] # recordar que el código de Qro es 22

# Ahora vamos a emparejar columnas del data frame descargado con información del data frame de mxmaps
Qro_COVID <- Qro_COVID %>%
  left_join(select(Qro_municipio, region, municipio_code, municipio_name),
            by = c("municipio_res" = "municipio_code"))

```

```{r, warning=FALSE, echo=FALSE, fig.align="center"}
Pos_Qro <- Qro_COVID[grep("Positivo", Qro_COVID$resultado),]


mn_Qro_2 <- ddply(Pos_Qro, c("fecha_sintomas", "tipo_paciente"), summarise,
                  casos = length(resultado))

n_Qro <- sum(mn_Qro_2$casos)

plot_casos_Qro <- ggplot(mn_Qro_2, aes(x = as.Date(fecha_sintomas), y = casos, fill = tipo_paciente))+
  geom_bar(stat = "identity") + 
  theme_classic()+
  scale_fill_manual("Tipo de paciente", values = c("Hospitalizado" = "green", "Ambulatorio" = "gray"))+
  labs(y = "Número de casos", x = "Fecha de síntomas")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12)) +
  annotate(geom="text", x=as.Date("2020-04-10"), y=85, label= c("n=            ",n_Qro),
              color="red")+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_casos_Qro)



mn_Qro_3 <- ddply(Qro_COVID, c("fecha_ingreso", "resultado"), summarise,
                  casos = length(resultado))

plot_ingreso_Qro <- ggplot(mn_Qro_3)+
  geom_bar(stat = "identity",  aes ( x = as.Date(fecha_ingreso), y = casos, fill = resultado)) + 
  theme(legend.position = "none") + 
  theme_classic() +
  labs(y = "Número de sospechosos", x = "Fecha de ingreso")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12))+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_ingreso_Qro)

```

# Datos para CDMX
```{r, warning=FALSE, echo=FALSE, fig.align="center"}
CDMX_COVID <- Mex_Data_COVID[grep("09",Mex_Data_COVID$entidad_res),]

# A partir de la librería mxmaps, obtener datos de municipios de Qro
data("df_mxmunicipio") # adjuntar información por municipio

CDMX_municipio <- df_mxmunicipio[df_mxmunicipio$state_code == 09,] # recordar que el código de Qro es 22

# Ahora vamos a emparejar columnas del data frame descargado con información del data frame de mxmaps
CDMX_COVID <- CDMX_COVID %>%
  left_join(select(CDMX_municipio, region, municipio_code, municipio_name),
            by = c("municipio_res" = "municipio_code"))

```

```{r, warning=FALSE, echo=FALSE, fig.align="center"}
Pos_CDMX <- CDMX_COVID[grep("Positivo", CDMX_COVID$resultado),]


mn_CDMX_2 <- ddply(Pos_CDMX, c("fecha_sintomas", "tipo_paciente"), summarise,
                  casos = length(resultado))

n_CDMX <- sum(mn_CDMX_2$casos)

plot_casos_CDMX <- ggplot(mn_CDMX_2, aes(x = as.Date(fecha_sintomas), y = casos, fill = tipo_paciente))+
  geom_bar(stat = "identity") + 
  theme_classic()+
  scale_fill_manual("Tipo de paciente", values = c("Hospitalizado" = "green", "Ambulatorio" = "gray"))+
  labs(y = "Número de casos", x = "Fecha de síntomas")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12)) +
  annotate(geom="text", x=as.Date("2020-04-10"), y=1150, label= c("n=               ",n_CDMX),
              color="red")+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_casos_CDMX)



mn_CDMX_3 <- ddply(CDMX_COVID, c("fecha_ingreso", "resultado"), summarise,
                  casos = length(resultado))

plot_ingreso_CDMX <- ggplot(mn_CDMX_3)+
  geom_bar(stat = "identity",  aes ( x = as.Date(fecha_ingreso), y = casos, fill = resultado)) + 
  theme(legend.position = "none") + 
  theme_classic() +
  labs(y = "Número de sospechosos", x = "Fecha de ingreso")+
  theme(axis.text.x = element_text(face = "bold", color = "#993333",size = 8, angle = 90),
        axis.text.y = element_text(face = "bold", color = "blue", size = 10, angle = 45),
        axis.title.x = element_text(face = "bold", color = "black", size = 12),
        axis.title.y = element_text(face = "bold", color = "black", size = 12))+
  scale_x_date(date_breaks = "months" , date_labels = "%b"); ggplotly(plot_ingreso_CDMX)

```

